{% extends 'backend/baseBack.html.twig' %}

{% block content %}
{{ importmap('app') }}
<link rel="stylesheet" href="{{ asset('css/Warehouse/floatingContainer.css') }}">
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">List of Bills</h6>
    </div>
    <div style="display: flex; align-self:center; gap: 20px;">
    <button class="refresh"><a href="{{ path('bill') }}"><svg width="12" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
      <path d="M463.5 224l8.5 0c13.3 0 24-10.7 24-24l0-128c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8l119.5 0z"/>
    </svg></a></button>
    <div class="dropdown">
        <button class="dropdown-button" onclick="toggleDropdownSort()">Sort by</button>
        <div class="dropdown-content" id="dropdownSortMenu">
            <a href="#" id="sortDateDESC">Date <svg xmlns="http://www.w3.org/2000/svg" width=12 height=12 viewBox="0 0 320 512"><path fill="#ddd" d="M318 177.5c3.8-8.8 2-19-4.6-26l-136-144C172.9 2.7 166.6 0 160 0s-12.9 2.7-17.4 7.5l-136 144c-6.6 7-8.4 17.2-4.6 26S14.4 192 24 192l72 0 0 288c0 17.7 14.3 32 32 32l64 0c17.7 0 32-14.3 32-32l0-288 72 0c9.6 0 18.2-5.7 22-14.5z"/></svg></a>
            <a href="#" id="sortDateASC">Date <svg xmlns="http://www.w3.org/2000/svg" width=12 height=12 viewBox="0 0 320 512"><path fill="#ddd" d="M2 334.5c-3.8 8.8-2 19 4.6 26l136 144c4.5 4.8 10.8 7.5 17.4 7.5s12.9-2.7 17.4-7.5l136-144c6.6-7 8.4-17.2 4.6-26s-12.5-14.5-22-14.5l-72 0 0-288c0-17.7-14.3-32-32-32L128 0C110.3 0 96 14.3 96 32l0 288-72 0c-9.6 0-18.2 5.7-22 14.5z"/></svg></a>
            <a href="#" id="sortAmountASC">Amount <svg xmlns="http://www.w3.org/2000/svg" width=12 height=12 viewBox="0 0 320 512"><path fill="#ddd" d="M318 177.5c3.8-8.8 2-19-4.6-26l-136-144C172.9 2.7 166.6 0 160 0s-12.9 2.7-17.4 7.5l-136 144c-6.6 7-8.4 17.2-4.6 26S14.4 192 24 192l72 0 0 288c0 17.7 14.3 32 32 32l64 0c17.7 0 32-14.3 32-32l0-288 72 0c9.6 0 18.2-5.7 22-14.5z"/></svg></a>
            <a href="#" id="sortAmountDESC">Amount <svg xmlns="http://www.w3.org/2000/svg" width=12 height=12 viewBox="0 0 320 512"><path fill="#ddd" d="M2 334.5c-3.8 8.8-2 19 4.6 26l136 144c4.5 4.8 10.8 7.5 17.4 7.5s12.9-2.7 17.4-7.5l136-144c6.6-7 8.4-17.2 4.6-26s-12.5-14.5-22-14.5l-72 0 0-288c0-17.7-14.3-32-32-32L128 0C110.3 0 96 14.3 96 32l0 288-72 0c-9.6 0-18.2 5.7-22 14.5z"/></svg></a>
        </div>
    </div>
    <div class="dropdown">
        <button class="dropdown-button" onclick="toggleDropdownFilter()">Filter by</button>
        <div class="dropdown-content" id="dropdownFilterMenu">
            <a href="#" id="filterPaid">Paid bills</a>
            <a href="#" id="filterUnpaid">Unpaid bills</a>
        </div>
    </div>
    <div class="alignSearchSVG">
    <input type="text" id="searchInput" placeholder="Search..." />
    <svg id="searchIconButton" xmlns="http://www.w3.org/2000/svg" style="margin-left:5px;" height="12" width="12" viewBox="0 0 512 512">
        <path fill="#ddd" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/>
    </svg>
    </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped shadow" id="dataTable">
                <thead class="thead">
                    <tr>
                        <th>Car</th>
                        <th>Client</th>
                        <th>Price</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th class="action-column">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in bills %}
                        <tr>
                            <td>{{ bill.car.brandCar ~ ' ' ~ bill.car.modelCar }}</td>
                            <td>{{ bill.user.firstNameUser ~ ' ' ~ bill.user.lastNameUser }}</td>
                            <td>{{ bill.totalAmountBill ~ ' DT' }}</td>
                            <td>{{ bill.dateBill|date('Y-m-d') }}</td>
                            <td>
                                {% if bill.statusBill == 1 %}
                                    <span class="paidBill">Paid</span>
                                {% else %}
                                    <span class="pendingBill">Pending</span>
                                {% endif %}
                            </td>
                            <td class="action-column">
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ path('updateBill', {'id': bill.idBill}) }}" class="btn btn-warning btn-sm" title="Update">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ path('deleteBill', {'id': bill.idBill}) }}" class="btn btn-danger btn-sm" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">
                                No records found
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="pagination" style="margin-top: 20px;">
    {% if currentPage > 1 %}
        <a href="{{ path('bill', {'page': currentPage - 1}) }}">Previous</a>
    {% endif %}

    {% for i in 1..totalPages %}
        <a href="{{ path('bill', {'page': i}) }}"
           class="{{ i == currentPage ? 'active' : '' }}">
            {{ i }}
        </a>
    {% endfor %}

    {% if currentPage < totalPages %}
        <a href="{{ path('bill', {'page': currentPage + 1}) }}">Next</a>
    {% endif %}
</div>
</div>
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Statistical Analysis of the Income</h6>
    </div>
    <div class="card-body charts-container" id="billLineChart" style="height:400px;">
        <div class="chart-box">
            {{ render_chart(chart) }}
        </div>

        <div class="chart-box">
            {{ render_chart(pieChart) }}
        </div>
    </div>
    <div class="card-header py-3">
        <div class="dropdown">
        <button class="dropdown-button" id="yearSelected" onclick="toggleDropdownStats()">{{ year }}</button>
        <div class="dropdown-content" id="dropdownStatMenu">
            {% for statYear in allYears %}
                <a href="#" class="year-option" data-year="{{ statYear }}">{{ statYear }}</a>
            {% endfor %}
        </div>
    </div>
    </div>
</div>
<script>
  // Dropdown toggle
  function toggleDropdownFilter() {
    const dropdown = document.getElementById("dropdownFilterMenu");
    dropdown.classList.toggle("show");
  }
    function toggleDropdownSort() {
        const dropdown = document.getElementById("dropdownSortMenu");
        dropdown.classList.toggle("show");
    }
    function toggleDropdownStats() {
        const dropdown = document.getElementById("dropdownStatMenu");
        dropdown.classList.toggle("show");
    }

  window.onclick = function(event) {
    if (!event.target.matches('.dropdown-button')) {
      const dropdownFilter = document.getElementById("dropdownFilterMenu");
      if (dropdownFilter && dropdownFilter.classList.contains("show")) {
        dropdownFilter.classList.remove("show");
      }
      const dropdownSort = document.getElementById("dropdownSortMenu");
      if (dropdownSort && dropdownSort.classList.contains("show")) {
        dropdownSort.classList.remove("show");
      }
    }
  }
  //AJAX filter by paid bills
  document.getElementById('filterPaid').addEventListener('click', function(e) {
    e.preventDefault();

    fetch('/dashboard/bill/paid_bills')
        .then(handleAjaxResponse)
        .then(data => updateBillTable(data))
        .catch(handleAjaxError);
    });
//AJAX filter by unpaid bills
document.getElementById('filterUnpaid').addEventListener('click', function(e) {
    e.preventDefault();

    fetch('/dashboard/bill/unpaid_bills')
        .then(handleAjaxResponse)
        .then(data => updateBillTable(data))
        .catch(handleAjaxError);
    });
//AJAX sort by date ascending
document.getElementById('sortDateASC').addEventListener('click', function(e) {
    e.preventDefault();

    fetch('/dashboard/bill/sort_date_asc')
        .then(handleAjaxResponse)
        .then(data => updateBillTable(data))
        .catch(handleAjaxError);
    });
//AJAX sort by date descending
document.getElementById('sortDateDESC').addEventListener('click', function(e) {
    e.preventDefault();

    fetch('/dashboard/bill/sort_date_desc')
        .then(handleAjaxResponse)
        .then(data => updateBillTable(data))
        .catch(handleAjaxError);

    });
//AJAX sort by price ascending
document.getElementById('sortAmountASC').addEventListener('click', function(e) {
    fetch('/dashboard/bill/sort_amount_asc')
        .then(handleAjaxResponse)
        .then(data => updateBillTable(data))
        .catch(handleAjaxError);

    });
//AJAX sort by price descending
document.getElementById('sortAmountDESC').addEventListener('click', function(e) {
    fetch('/dashboard/bill/sort_amount_desc')
        .then(handleAjaxResponse)
        .then(data => updateBillTable(data))
        .catch(handleAjaxError);
});
function handleAjaxResponse(response) {
if (!response.ok) {
    throw new Error('No results found.');
}
return response.json();
}
function handleAjaxError(error) {
    console.error('Error:', error);
    document.querySelector('#dataTable tbody').innerHTML = `
        <tr>
            <td colspan="6" class="text-center text-muted py-3">No results found</td>
        </tr>
    `;
}
function updateBillTable(bills) {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = ''; // clear existing

    bills.forEach(bill => {
        const row = `
            <tr>
                <td>${bill.car.brandCar} ${bill.car.modelCar}</td>
                <td>${bill.user.firstNameUser} ${bill.user.lastNameUser}</td>
                <td>${bill.totalAmountBill} DT</td>
                <td>${bill.dateBill.split('T')[0]}</td>
                <td>${bill.statusBill === 1 ? '<span class="paidBill"> Paid </span>' :  '<span class="paidBill"> Pending</span>'}</td>
                <td class="action-column">
                    <div class="btn-group btn-group-sm">
                        <a href="/dashboard/bill/update/${bill.idBill}" class="btn btn-warning btn-sm" title="Update">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="/dashboard/bill/delete/${bill.idBill}" class="btn btn-danger btn-sm" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </div>
                </td>
            </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    });
    }
  document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("searchInput");
  input.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      triggerAjax(input.value);
    }
    });
    });

    function triggerAjax(query) {
    console.log("AJAX triggered with:", query);
    fetch('/dashboard/bill/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('No results found.');
        }
        return response.json();
    })
    .then(data => updateBillTable(data))
    .catch(error => {
        console.error('Error:', error);
        document.querySelector('#dataTable tbody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-3">No results found</td>
            </tr>
        `;
    });
    document.getElementById("searchIconButton").addEventListener("click", function() {
        triggerAjax(document.getElementById("searchInput").value);
    });
    }
    document.querySelectorAll('.year-option').forEach(option => {
    option.addEventListener('click', async function (e) { // Add async here
        try {
            const response = await fetch('{{ path("bill") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({ 'statYear': this.dataset.year }) 
            });
            const data = await response.json();

            if (data.success && data.chart) {
                const billLineChart = document.querySelector('#billLineChart');
                billLineChart.innerHTML = data.chart; 
                document.querySelector('#yearSelected').innerText = `${this.dataset.year}`;
            } else {
                console.error("Fetch failed:", data.message || 'Unexpected error');
            }
        } catch (error) {
            console.error('AJAX error:', error);
        }
    });
});
</script>
{% endblock %}

