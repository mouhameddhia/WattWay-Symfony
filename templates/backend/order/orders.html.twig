{% extends 'backend/baseBack.html.twig' %}

{% block content %}
<link rel="stylesheet" href="{{ asset('back/css/ordersBack.css') }}">

{% set highlightId = app.request.get('highlight') %}

{% for label, messages in app.flashes %}
    {% for message in messages %}
        <div class="flash-message flash-{{ label }}">
            {{ message }}
        </div>
    {% endfor %}
{% endfor %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <a href="{{ path('order_create') }}" class="btn btn-success btn-sm order-1">
            <i class="fas fa-plus me-1"></i> Create New Order
        </a>
        
        <div class="d-flex flex-grow-1 flex-lg-grow-0 gap-2 order-2 order-lg-3" style="min-width: 300px; max-width: 800px;">
            <!-- Search by Item Name -->
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="itemSearch" class="form-control" placeholder="Search by item name...">
                <button class="btn btn-outline-secondary" type="button" id="searchItemBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <!-- Month Selector -->
            <div class="input-group input-group-sm" style="width: 250px;">
                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                <select id="monthFilter" class="form-select form-select-sm">
                    <option value="all" selected>All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            
            

        </div>
    </div>

    <!-- Orders Table Container -->
    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-sm table-bordered mb-1">
            <thead class="thead-dark" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th style="width: 5%; text-align: center;">ID</th>
                    <th style="width: 12%; text-align: center;">Supplier</th>
                    <th style="width: 33%; text-align: center;">Address Supplier</th>
                    <th style="width: 10%; text-align: center;">Date</th>
                    <th style="width: 12%; text-align: center;">Status</th>
                    <th style="width: 10%; text-align: center;">Total Amount</th>
                    <th style="width: 8%; text-align: center;">User</th>
                    <th style="width: 10%; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr class="clickable-order 
    {{ order.supplierOrder == 'WattShop' ? 'wattshop-row' : '' }} 
    {{ order.idOrder == highlightId|default('')|number_format(0, '.', '') ? 'highlighted-row' : '' }}
" 
    data-order-id="{{ order.idOrder }}">
                       
                        <td style="text-align: center;">{{ order.idOrder }}</td>
                        <td>{{ order.supplierOrder }}</td>
                        <td class="text-wrap" style="word-break: break-word; white-space: normal;">
                            {{ order.addressSupplierOrder }}
                        </td>
                        <td style="text-align: center;">{{ order.dateOrder ? order.dateOrder|date('m/d/Y') : 'â€”' }}</td>
                        <td style="text-align: center;">
                            <span class="badge badge-pill badge-{{ 
                                order.statusOrder == 'Delivered' ? 'success' : 
                                (order.statusOrder == 'Pending' ? 'warning' : 
                                (order.statusOrder == 'Cancelled' ? 'danger' : 'secondary')) 
                            }} status-badge">
                                {{ order.statusOrder }}
                            </span>
                        </td>
                        <td style="text-align: center;">${{ order.totalAmountOrder|number_format(2) }}</td>
                        <td style="text-align: center;">{{ order.idAdmin }}</td>
                        
                        <td style="text-align: center;" class="py-1">
                            <div class="d-flex justify-content-center gap-1">
                                {% if order.statusOrder == 'Pending' %}
                                    <a href="#" class="btn btn-primary btn-sm py-0 px-2 edit-order-btn" 
                                       data-order-id="{{ order.idOrder }}" 
                                       data-supplier="{{ order.supplierOrder }}"
                                       data-date="{{ order.dateOrder ? order.dateOrder|date('Y-m-d') : '' }}"
                                       data-status="{{ order.statusOrder }}"
                                       data-total="{{ order.totalAmountOrder }}"
                                       data-address="{{ order.addressSupplierOrder }}">Edit</a>
                                {% else %}
                                    <button class="btn btn-secondary btn-sm py-0 px-2" disabled title="Only Pending orders can be edited">
                                        Edit
                                    </button>
                                {% endif %}
                                <a href="{{ path('order_delete', {'idOrder': order.idOrder}) }}" class="btn btn-danger btn-sm py-0 px-2" 
                                   onclick="return confirm('Are you sure you want to delete this order?');">Delete</a>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-2">No orders found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="card shadow-sm mt-4" >
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0" id="chartTitle">Order Statistics</h5>
            <div class="d-flex gap-2">
                <select id="statsTimeRange" class="form-select form-select-sm" style="width: 120px;">
                    <option value="monthly" selected>Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <select id="statsYear" class="form-select form-select-sm" style="width: 90px;">
                    {% for year in range("now"|date("Y"), "now"|date("Y") - 5) %}
                        <option value="{{ year }}" {{ year == "now"|date("Y") ? 'selected' }}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="card-body position-relative" style="padding-bottom: 30px;">
            <!-- Left Arrow -->
            <div id="arrowLeft" class="chart-arrow" style="position: relative; left: -75px;top: 160px;">
                <i class="fas fa-chevron-left fa-2x"></i>
            </div>
            
            
            <!-- Chart Container -->
            <div class="row">
                <div class="col-md-8">
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex flex-column h-100 justify-content-between">
                        <div class="mb-3" id="statsSummary">
                            <h6 class="text-muted mb-2">Summary</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Total Orders</span>
                                <span class="fw-bold">{{ total_orders_count }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Admin Orders</span>
                                <span class="fw-bold text-primary">{{ admin_orders_count }} ({{ (admin_orders_count/total_orders_count*100)|round(1) }}%)</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Client Orders</span>
                                <span class="fw-bold text-info">{{ client_orders_count }} ({{ (client_orders_count/total_orders_count*100)|round(1) }}%)</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Completed</span>
                                <span class="fw-bold text-success">{{ completed_orders_count }} ({{ (completed_orders_count/total_orders_count*100)|round(1) }}%)</span>
                            </div>
                        </div>
                        <div class="mt-auto" id="monthlyAverage">
                            <h6 class="text-muted mb-2">Monthly Average</h6>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small>Admin Orders</small>
                                <small class="fw-bold">{{ (admin_orders_count/12)|round(1) }}/month</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small>Client Orders</small>
                                <small class="fw-bold">{{ (client_orders_count/12)|round(1) }}/month</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Arrow -->
            <div id="arrowRight"  style="position: relative; left: 1300px;bottom: 173px;" class="chart-arrow">
                <i class="fas fa-chevron-right fa-2x"></i>
            </div>
            <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editOrderModalLabel">Edit Order #<span id="editOrderId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editSupplier" class="form-label">Supplier</label>
                            <input type="text" class="form-control" id="editSupplier" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="editDate" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStatus" required>
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="Shipped">Shipped</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editTotal" class="form-label">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" id="editTotal" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAddress" class="form-label">Supplier Address</label>
                        <textarea class="form-control" id="editAddress" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveOrderChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>
</div>


{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.adminOrdersData = {{ admin_orders_by_month|json_encode|raw }};
    window.clientOrdersData = {{ client_orders_by_month|json_encode|raw }};
    window.expensesData = {{ expenses_by_month|json_encode|raw }};
    window.revenuesData = {{ revenues_by_month|json_encode|raw }};


    
</script>
<script src="{{ asset('back/js/orderBack.js') }}"></script>


{% endblock %}

{% endblock %}